<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>Hk-Tree-Service</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c271d3d7aa3cd2e6702892fa92c3b313&libraries=services&autoload=false"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* (기존 CSS와 동일, 변경 없음) */
        :root {
            --sidebar-width: 280px;
            --tree-sidebar-width: 300px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }
        .container { display: flex; height: 100%; }
        .sidebar {
            width: var(--sidebar-width); background: #f8f9fa; border-right: 1px solid #e9ecef;
            display: flex; flex-direction: column; transition: transform 0.3s ease, width 0.3s ease, min-width 0.3s ease; z-index: 3000;
        }
        .sidebar-header {
            background: #2c3e50; color: white; text-align: center; padding: 15px; flex-shrink: 0;
        }
        .sidebar-content { flex: 1; overflow-y: auto; }
        .sidebar-footer {
            padding: 10px; border-top: 1px solid #e9ecef; display: flex;
            flex-direction: column; gap: 5px; flex-shrink: 0;
        }
        .footer-buttons { display: flex; gap: 5px; }
        .folder-list { padding: 10px; }
        details { margin-bottom: 8px; }
        summary {
            font-weight: bold; font-size: 14px; padding: 8px; background: #e9ecef;
            border-radius: 4px; cursor: pointer; list-style: none; position: relative;
            display: flex; justify-content: space-between; align-items: center;
        }
        summary::before {
            content: '▶'; font-size: 10px; margin-right: 8px; transition: transform 0.2s;
        }
        details[open] > summary::before { transform: rotate(90deg); }
        summary:hover .folder-actions { display: flex; }
        .folder-name { flex-grow: 1; }
        .folder-actions { display: none; gap: 5px; }
        .group-container { padding-left: 20px; margin-top: 5px; }
        .group-item {
            padding: 10px 12px; margin: 4px 0; background: white; border: 1px solid #dee2e6;
            border-radius: 4px; font-size: 13px; transition: background-color 0.2s;
            position: relative; display: flex; justify-content: space-between;
            align-items: flex-start; word-wrap: break-word; min-height: 32px;
        }
        .group-item:active { background-color: #d1e7fd; }
        .group-content { display: flex; align-items: flex-start; gap: 8px; flex: 1; }
        .group-checkbox { margin-top: 2px; cursor: pointer; transform: scale(1.2); }
        .group-name {
            flex: 1; word-wrap: break-word; word-break: break-all;
            line-height: 1.4; margin-right: 5px; cursor: pointer;
        }
        .group-item.active { background: #007bff; color: white; border-color: #007bff; }
        .folder-list summary { padding: 4px 6px; font-size: 10px; }
        .folder-list .group-item { padding: 4px 8px; margin: 1px 0; font-size: 10px; }
        .folder-list .group-name { line-height: 1.2; }
        .tree-list .group-item { font-size: 10px; padding: 5px 7px; margin: 1px 0; cursor: pointer; }
        .tree-list .group-item .small-text { font-size: 9px; color: #6c757d; line-height: 1.3; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .action-btn { padding: 2px 6px; border: none; border-radius: 2px; cursor: pointer; font-size: 10px; opacity: 0.8; }
        .action-btn:hover { opacity: 1; }
        .edit-btn { background: #ffc107; color: #333; }
        .delete-btn { background: #dc3545; color: white; }
        .main-content { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .tree-sidebar { width: var(--tree-sidebar-width); background: #f8f9fa; border-left: 1px solid #e9ecef; display: flex; flex-direction: column; transition: transform 0.3s ease, width 0.3s ease, min-width 0.3s ease; z-index: 3000; }
        .tree-section { overflow-y: auto; flex: 1; }
        .tree-list { padding: 10px; }
        .tree-pagination { padding: 10px; text-align: center; background: #f8f9fa; border-bottom: 1px solid #e9ecef; font-size: 11px; }
        .page-btn { padding: 4px 8px; margin: 0 2px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 11px; border-radius: 3px; }
        .page-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .page-info { font-size: 11px; color: #666; margin: 0 10px; }
        .controls-container { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .controls-toggle-bar { text-align: center; cursor: pointer; padding: 2px 0; font-size: 12px; font-weight: bold; }
        .controls { display: flex; flex-direction: column; gap: 8px; padding: 5px; }
        .controls.hidden { display: none; }
        .map-controls, .search-controls { display: flex; gap: 5px; align-items: center; }
        .search-input { padding: 6px 10px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px; width: 150px; }
        .small-btn, .map-type-btn { padding: 6px 10px; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .small-btn { background: #17a2b8; color: white; border-color: #17a2b8; }
        .map-type-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .btn { padding: 8px 12px; border: none; border-radius: 3px; cursor: pointer; font-size: 13px; background: #007bff; color: white; flex: 1; }
        .btn-secondary { background: #6c757d; }
        .modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: white; margin: 5vh auto; padding: 20px; border-radius: 5px; width: 95%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        .sub-modal .modal-content { max-width: 350px; z-index: 5001; }
        .sub-modal .modal-content h4 { margin-bottom: 20px; }
        .form-group { margin-bottom: 12px; }
        .form-group-header { display: flex; align-items: center; margin-bottom: 5px; }
        .form-group-header .main-label { flex-grow: 1; font-size: 13px; font-weight: bold; }
        .form-group-header .checkbox-label { display: flex; align-items: center; gap: 4px; font-size: 12px; font-weight: normal; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .form-group label { font-size: 13px; display: block; text-align: left; font-weight: bold; margin-bottom: 4px;}
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; }
        .form-row { display: flex; gap: 10px; align-items: flex-start; }
        .form-row .form-group { flex: 1; margin-bottom: 12px; }
        .form-row .form-group .form-row { margin-bottom: 0; }
        .form-row > span { padding: 0 5px; }
        .defect-group { display: flex; justify-content: space-around; background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #e9ecef; }
        .defect-group label { font-weight: normal; font-size: 12px; display: flex; align-items: center; gap: 4px; cursor:pointer;}
        .defect-group input { width: auto; }
        .sub-modal .form-group { display: flex; align-items: center; gap: 8px; margin-bottom: 15px;}
        .sub-modal .form-group:last-child { margin-bottom: 0; }
        .sub-modal .form-group label { margin-bottom: 0; flex:1; font-weight: normal;}
        .sub-modal .form-group input[type="checkbox"] { width: auto; transform: scale(1.2); flex-shrink: 0; }
        .sub-modal textarea { height: 60px; }
        .filters { padding: 10px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        .filter-group { display: flex; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px; gap: 4px 8px; align-items: center; font-size: 11px; width: 100%; }
        .filter-group .filter-title { font-weight: bold; font-size: 12px; margin-right: 5px; white-space: nowrap; }
        .filter-group label { display: flex; align-items: center; gap: 3px; cursor: pointer; padding: 2px 4px; border-radius: 3px; transition: background-color 0.2s; white-space: nowrap; }
        .filter-group label:hover { background-color: #e9ecef; }
        .filter-group input[type="checkbox"] { margin: 0; transform: scale(0.9); }
        .filters #sortFilter { font-size: 12px; padding: 4px; }
        .color-selector { display: flex; gap: 5px; margin: 10px 0; }
        .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .color-option.active { border-color: #333; }
        .mobile-title { color: white; font-weight: bold; font-size: 16px; }
        .mobile-controls { display: none; }
        .backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2900; }
        .search-type-selector { display: flex; gap: 10px; margin-bottom: 8px; font-size: 12px; }
        .search-type-selector label { display: flex; align-items: center; gap: 4px; }
        #coordSearchContainer { display: none; }
        .coord-inputs { display: flex; gap: 5px; }
        .coord-inputs input { width: 120px; }
        .sidebar-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); z-index: 2500; background-color: #2c3e50; color: white; border: 1px solid #fff; width: 25px; height: 50px; border-radius: 0 5px 5px 0; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 1px 0 5px rgba(0,0,0,0.2); }
        #toggle-left-sidebar-desktop { left: 5px; }
        #toggle-right-sidebar-desktop { right: 5px; border-radius: 5px 0 0 5px; }
        .sidebar.collapsed, .tree-sidebar.collapsed { width: 0; min-width: 0; overflow: hidden; border: none; padding-left: 0; padding-right: 0; }
        .desktop-only { display: block; }

        /* --- 기능 추가: 위치 수정/복사를 위한 안내 메시지 스타일 --- */
        #map-action-overlay {
            display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px;
            border-radius: 5px; z-index: 1500; font-size: 14px; text-align: center;
        }
        #map-action-overlay button {
            background: #dc3545; color: white; border: none; padding: 4px 8px;
            font-size: 12px; border-radius: 3px; margin-left: 10px; cursor: pointer;
        }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 260px; --tree-sidebar-width: 280px; }
            .sidebar { position: fixed; top: 52px; left: 0; height: calc(100% - 52px); transform: translateX(calc(var(--sidebar-width) * -1)); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .tree-sidebar { position: fixed; top: 52px; right: 0; height: calc(100% - 52px); transform: translateX(var(--tree-sidebar-width)); box-shadow: -2px 0 10px rgba(0,0,0,0.1); border-left: none; }
            .sidebar.visible, .tree-sidebar.visible { transform: translateX(0); }
            .main-content { height: 100%; }
            .controls-container { top: 62px; }
            #map-action-overlay { top: 62px; width: 100%; border-radius: 0; }
            .mobile-controls { position: fixed; top: 0; left: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; background: #2c3e50; color: white; padding: 10px; z-index: 4000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); height: 52px; }
            .mobile-btn { background: none; border: 1px solid white; color: white; padding: 8px 12px; border-radius: 4px; font-size: 13px; }
            .coord-inputs { flex-direction: column; }
            .coord-inputs input { width: 100%; }
            .tree-list .group-item { padding: 5px 8px; }
            .tree-list .group-item .small-text { margin-top: 1px; }
            .desktop-only { display: none; }
        }
    </style>
</head>
<body>
    <div id="login-modal" class="modal" style="display: flex;"> ... </div>
    <div id="signup-modal" class="modal"> ... </div>
    
    <div class="mobile-controls"> ... </div>
    <div class="backdrop" id="backdrop"></div>

    <div class="container" id="app-container" style="display: none;">
        <div class="sidebar" id="left-sidebar"> ... </div>

        <div class="main-content">
            <button id="toggle-left-sidebar-desktop" class="sidebar-toggle-btn desktop-only">◀</button>
            <button id="toggle-right-sidebar-desktop" class="sidebar-toggle-btn desktop-only">▶</button>
            <div class="controls-container"> ... </div>

            <div id="map-action-overlay"></div>
            
            <div id="map"></div>
        </div>

        <div class="tree-sidebar" id="right-sidebar"> ... </div>
    </div>
    
    <div id="folderModal" class="modal"> ... </div>
    <div id="groupModal" class="modal"> ... </div>

    <div id="treeModal" class="modal"><div class="modal-content">
        <h4 id="treeModalTitle">수목 정보 입력</h4>
        <form id="treeForm">
            <div class="form-row">...</div>
            
            <div style="text-align: right; margin-top: 15px; display: flex; flex-wrap: wrap; gap: 5px;">
                <button type="button" id="modalDeleteBtn" class="btn" style="background: #dc3545; margin-right: auto; display: none;">삭제</button>
                
                <button type="button" id="modalModifyLocationBtn" class="btn btn-secondary" style="display: none;">위치 수정</button>
                <button type="button" id="modalCopyBtn" class="btn btn-secondary" style="display: none;">복사하기</button>
                
                <div style="flex-basis: 100%; height: 0;"></div> <button type="button" class="btn btn-secondary" onclick="closeModalById('treeModal')">취소</button>
                <button type="submit" class="btn">저장</button>
            </div>
        </form>
    </div></div>
    
    <div id="stemDefectModal" class="modal sub-modal"> ... </div>
    <div id="rootDefectModal" class="modal sub-modal"> ... </div>
    <div id="targetModal" class="modal sub-modal"> ... </div>

    <script>
    // (상단 변수 선언 생략 - 이전과 동일)
    const firebaseConfig = { /* ... */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let map; let selectedColor = 'green'; let currentGroup = null; let folders = []; let groups = [];
    let trees = []; let currentTreeId = null; let currentClickPosition = null; let markers = [];
    let geocoder; let currentFolderId = null; let currentGroupId = null; let currentTreePage = 1;
    let treesPerPage = 20; let myLocationMarker = null;
    const colorMap = { red: '#ff4757', green: '#2ed573', blue: '#3742fa', orange: '#ffa502', gray: '#a4b0be' };
    const validColors = Object.keys(colorMap);

    // --- 기능 추가: 위치 수정/복사를 위한 상태 변수 ---
    let currentAction = null; // 'modify_location' 또는 'copy_tree'
    let actionData = null; // 수정할 나무 ID 또는 복사할 나무 데이터 저장

    document.addEventListener('DOMContentLoaded', function() {
        kakao.maps.load(initMap);
        setupEventListeners();
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                auth.onAuthStateChanged(user => {
                    // (로그인 처리 로직 생략 - 이전과 동일)
                });
            })
            .catch(error => { console.error("Auth persistence error:", error); });
    });

    function setupEventListeners() {
        // (기존 이벤트 리스너 생략 - 이전과 동일)
        document.getElementById('loginBtn').addEventListener('click', () => { /* ... */ });
        
        // --- 기능 추가: 위치 수정, 복사 버튼 이벤트 리스너 ---
        document.getElementById('modalModifyLocationBtn').addEventListener('click', startModifyLocation);
        document.getElementById('modalCopyBtn').addEventListener('click', startCopyTree);

        // --- 기능 추가: ESC 키로 작업 취소 ---
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape" && currentAction) {
                cancelCurrentAction();
            }
        });
    }
    
    function openTreeModal(treeId = null) {
        currentTreeId = treeId;
        const modal = document.getElementById('treeModal');
        // (기존 openTreeModal 로직 생략 - 이전과 동일)

        // --- 기능 추가: 버튼 표시/숨김 로직 ---
        const modifyBtn = document.getElementById('modalModifyLocationBtn');
        const copyBtn = document.getElementById('modalCopyBtn');
        
        if (treeId) { // 기존 나무 수정 시에만 버튼 표시
            modifyBtn.style.display = 'inline-block';
            copyBtn.style.display = 'inline-block';
        } else { // 새 나무 생성 시에는 숨김
            modifyBtn.style.display = 'none';
            copyBtn.style.display = 'none';
        }

        modal.style.display = 'flex';
    }

    // --- 기능 추가: 지도 위 안내 메시지 표시 함수 ---
    function showActionOverlay(message) {
        const overlay = document.getElementById('map-action-overlay');
        overlay.innerHTML = `${message} <button onclick="cancelCurrentAction()">취소</button>`;
        overlay.style.display = 'block';
        map.getContainer().style.cursor = 'crosshair';
    }

    // --- 기능 추가: 안내 메시지 숨김 및 상태 초기화 함수 ---
    function cancelCurrentAction() {
        document.getElementById('map-action-overlay').style.display = 'none';
        map.getContainer().style.cursor = '';
        currentAction = null;
        actionData = null;
    }

    // --- 기능 추가: 위치 수정 시작 ---
    function startModifyLocation() {
        const tree = trees.find(t => t.id === currentTreeId);
        if (!tree) return;
        
        currentAction = 'modify_location';
        actionData = { treeId: tree.id };
        closeModalById('treeModal');
        showActionOverlay(`'${tree.number}'번 수목의 새 위치를 선택하세요... (ESC로 취소)`);
    }

    // --- 기능 추가: 복사하기 시작 ---
    function startCopyTree() {
        const tree = trees.find(t => t.id === currentTreeId);
        if (!tree) return;
        
        currentAction = 'copy_tree';
        const { id, lat, lng, createdAt, ...treeDataToCopy } = tree; // 복사할 데이터 준비
        actionData = { treeData: treeDataToCopy };
        closeModalById('treeModal');
        showActionOverlay(`'${tree.number}'번 수목을 복사할 새 위치를 선택하세요... (ESC로 취소)`);
    }

    // --- 기능 추가: 지도 클릭 시 동작 처리 ---
    async function handleMapActionClick(mouseEvent) {
        if (!currentAction) return;

        const latlng = mouseEvent.latLng;
        const newPosition = { lat: latlng.getLat(), lng: latlng.getLng() };

        try {
            if (currentAction === 'modify_location') {
                await db.collection('users').doc(currentUser.uid).collection('trees').doc(actionData.treeId)
                    .update({ lat: newPosition.lat, lng: newPosition.lng });
                alert('위치가 수정되었습니다.');
                await loadUserData(); // 데이터 새로고침
            } 
            else if (currentAction === 'copy_tree') {
                const newTreeData = {
                    ...actionData.treeData,
                    ...newPosition,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                const docRef = await db.collection('users').doc(currentUser.uid).collection('trees').add(newTreeData);
                
                // 로컬 데이터에도 즉시 추가
                trees.push({ id: docRef.id, ...newTreeData });
                updateFolderList();
                updateMapMarkers();
                
                // 새 나무의 정보 입력창 바로 열기
                openTreeModal(docRef.id); 
            }
        } catch(error) {
            console.error("작업 실패:", error);
            alert("작업에 실패했습니다.");
        } finally {
            cancelCurrentAction(); // 작업 완료 후 상태 초기화
        }
    }

    function initMap() {
        const container = document.getElementById('map');
        const options = { /* ... */ };
        map = new kakao.maps.Map(container, options);
        geocoder = new kakao.maps.services.Geocoder();

        // --- 기능 추가: 지도 클릭 리스너 ---
        kakao.maps.event.addListener(map, 'click', handleMapActionClick);
        
        kakao.maps.event.addListener(map, 'rightclick', (e) => {
            if(currentAction) return; // 다른 작업 중일 때는 새 나무 추가 방지
            addNewTreeAt(e.latLng)
        });
        addLongPressListener(container, (e) => {
            if(currentAction) return;
            // (기존 addLongPressListener 로직)
        });
        container.addEventListener('contextmenu', e => e.preventDefault());
        updateMapMarkers();
    }
    
    function updateMapMarkers() {
        if (!map) return;
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        // (기존 로직 생략)
        
        visibleTrees.forEach(tree => {
            // (기존 로직 생략)
            
            // 라벨 색상 흰색으로 변경
            const svgString = `
              <svg xmlns="http://www.w3.org/2000/svg" width="${svgWidth}" height="${svgHeight}">
                <rect x="1" y="1" width="${svgWidth - 2}" height="${rectHeight}" rx="${rectRadius}" ry="${rectRadius}" fill="${colorMap[tree.color] || colorMap.gray}" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
                <path d="M ${svgWidth/2 - pointerWidth} ${rectHeight} L ${svgWidth/2} ${svgHeight} L ${svgWidth/2 + pointerWidth} ${rectHeight} Z" fill="${colorMap[tree.color] || colorMap.gray}"/>
                <text x="${svgWidth/2}" y="${textY}" font-size="${fontSize}" font-weight="bold" text-anchor="middle" fill="white">${text}</text>
              </svg>`;
            
            // (이하 로직 생략)
        });
    }
    
    function showMyLocation() {
        if (location.protocol !== 'https:') {
            return alert('보안(HTTPS) 연결이 필요합니다. 아이폰, 아이패드 등 iOS 기기에서는 HTTPS 환경에서만 위치 정보를 사용할 수 있습니다.');
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => { /* ... */ },
                (error) => {
                    let errorMessage = "위치 정보를 가져올 수 없습니다.";
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "위치 정보 권한이 차단되었습니다.\n아이폰 설정 > 개인정보 보호 및 보안 > 위치 서비스에서 브라우저의 위치 권한을 확인해주세요.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "현재 위치를 찾을 수 없습니다.\nGPS 또는 네트워크 연결을 확인해주세요.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "위치를 가져오는 데 시간이 초과되었습니다.";
                            break;
                    }
                    alert(errorMessage);
                }
            );
        } else {
            alert("이 브라우저에서는 위치 정보를 지원하지 않습니다.");
        }
    }

    // (이하 나머지 함수들은 이전과 동일합니다)
    </script>
</body>
</html>
