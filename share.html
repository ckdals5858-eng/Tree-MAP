<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공유된 수목 위치</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c271d3d7aa3cd2e6702892fa92c3b313&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        #message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 8px; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="message" style="display: none;"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBw6TBu2uPgSBW2_E_PUIs-uI_MZVs2hlA",
            authDomain: "treemap-46453.firebaseapp.com",
            projectId: "treemap-46453",
            storageBucket: "treemap-46453.appspot.com",
            messagingSenderId: "629734840216",
            appId: "1:629734840216:web:8dbe1e33662fe844eefded"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const colorMap = { red: '#ff4757', green: '#2ed573', blue: '#3742fa', orange: '#ffa502', gray: '#a4b0be' };

        document.addEventListener('DOMContentLoaded', () => {
            kakao.maps.load(loadSharedMap);
        });

        function showMessage(text) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.style.display = 'block';
        }

        async function loadSharedMap() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('id');

            if (!shareId) {
                return showMessage('유효하지 않은 공유 링크입니다.');
            }

            try {
                const docRef = db.collection('shares').doc(shareId);
                const docSnap = await docRef.get();

                // ⭐ 아래 부분을 docSnap.exists() 에서 docSnap.exists 로 수정했습니다.
                if (!docSnap.exists) {
                    return showMessage('공유 데이터를 찾을 수 없거나 삭제되었습니다.');
                }

                const sharedData = docSnap.data();
                const trees = sharedData.trees || [];

                if (trees.length === 0) {
                    return showMessage('공유된 수목이 없습니다.');
                }

                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(trees[0].lat, trees[0].lng),
                    level: 5
                };
                const map = new kakao.maps.Map(mapContainer, mapOption);
                const bounds = new kakao.maps.LatLngBounds();

                trees.forEach(tree => {
                    if (typeof tree.lat !== 'number' || typeof tree.lng !== 'number') return;
                    
                    const position = new kakao.maps.LatLng(tree.lat, tree.lng);
                    const text = tree.number || '';
                    
                    let textWidth = 0;
                    for (let i = 0; i < text.length; i++) {
                        const char = text.charCodeAt(i);
                        textWidth += (char >= 0xAC00 && char <= 0xD7A3) ? 9 : 4.8;
                    }
                    const padding = 12;
                    const svgWidth = Math.max(18, textWidth + padding);
                    const svgHeight = 23, rectHeight = 16, rectRadius = 8, pointerWidth = 5, fontSize = 10, textY = 13;
                    
                    const svgString = `
                      <svg xmlns="http://www.w3.org/2000/svg" width="${svgWidth}" height="${svgHeight}">
                          <rect x="1" y="1" width="${svgWidth - 2}" height="${rectHeight}" rx="${rectRadius}" ry="${rectRadius}" fill="${colorMap[tree.color] || colorMap.gray}" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
                          <path d="M ${svgWidth/2 - pointerWidth} ${rectHeight} L ${svgWidth/2} ${svgHeight} L ${svgWidth/2 + pointerWidth} ${rectHeight} Z" fill="${colorMap[tree.color] || colorMap.gray}"/>
                          <text x="${svgWidth/2}" y="${textY}" font-size="${fontSize}" font-weight="bold" text-anchor="middle" fill="white">${text}</text>
                      </svg>`;

                    const imageSrc = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svgString)))}`;
                    const imageSize = new kakao.maps.Size(svgWidth, svgHeight);
                    const imageOption = { offset: new kakao.maps.Point(svgWidth / 2, svgHeight) };
                    const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
                    const marker = new kakao.maps.Marker({ position, image: markerImage });

                    marker.setMap(map);
                    bounds.extend(position);
                });

                map.setBounds(bounds);

            } catch (error) {
                console.error("Error loading shared data:", error);
                showMessage('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }
    </script>
</body>
</html>
